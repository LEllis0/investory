<div class="flex_row1">
    <canvas id="stockChart"></canvas>
    <button class="closeButton" onclick="hideStockHistoryChart('');">
        Close
    </button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.body.addEventListener('click', hideStockHistoryChart, true); 

    function hideStockHistoryChart() {
        var mainTile = document.getElementById("main_tile");
        var stockHistoryTile = document.getElementById("stock_history");

        stockHistoryTile.style="display: none;";
        mainTile.style="";
    };

    var stockHistoryChart = null;
    function updateStockHistoryChart(ticker) {
        fetch(`<%= base_url %>/history/${ticker}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            return response.json();
        })
        .then(response => {
            if (response.error) {
                console.error("Error fetching data:", response.message);
                return;
            }

            // Extract data from the response
            const data = response.data;
            const timestamps = data.map(item => item.timestamp);
            const closePrices = data.map(item => parseFloat(item.close_price));

            var positive = true;
            if (closePrices[0] > closePrices[closePrices.length - 1]) {
                positive = false;
            }

            const ctx = document.getElementById('stockChart').getContext('2d');
            if (stockHistoryChart != null) {
                stockHistoryChart.destroy();
            }
            stockHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: `${ticker} Stock Price`, 
                        data: closePrices,
                        borderColor: positive ? "#00c814" : "#FF0000",
                        backgroundColor: 'rgba(0, 0, 0, 0)',
                        borderWidth: 2,
                        fill: false ,
                        pointRadius: 0,
                        lineTension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Closing Price (USD)'
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error("There was a problem with the fetch operation:", error);
        });
    }
</script>
